name: Perform Release

on:
  push:
    tags:
      - '*'

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true  

permissions:
  contents: write
  packages: write
  
jobs:
  release-agent:
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/agent-')
    strategy:
      fail-fast: false
      matrix:
        target:
          - linux-x64
          - linux-arm64
          - windows-x64
          - darwin-x64
          - darwin-arm64
          - linux-x64-musl
          - linux-arm64-musl
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - id: tool-versions
        name: Get Tool Versions
        run: |
          for tool in $(cat .tool-versions | awk '{print $1}'); do
            echo "$tool=$(grep "$tool" .tool-versions | awk '{print $2}')" >> $GITHUB_OUTPUT
          done
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ steps.tool-versions.outputs.bun }}
      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ runner.os }}-node-modules-${{ hashFiles('**/bun.lock') }}
      - name: Bun Install
        run: bun install --frozen-lockfile
      - name: Build Agent
        working-directory: agent
        run: bun build --compile --target bun-${{ matrix.target }}  --minify --sourcemap --bytecode ./index.ts --outfile devicemonster-agent-${{ matrix.target }}
      - name: Upload Release Artifact
        working-directory: agent
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh release upload ${{ github.ref_name }} devicemonster-agent-${{ matrix.target }}*
  release-server:
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/server-')
    strategy:
      fail-fast: false
      matrix:
        target:
          - linux-x64
          - linux-arm64
          - windows-x64
          - darwin-x64
          - darwin-arm64
          - linux-x64-musl
          - linux-arm64-musl
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - id: tool-versions
        name: Get Tool Versions
        run: |
          for tool in $(cat .tool-versions | awk '{print $1}'); do
            echo "$tool=$(grep "$tool" .tool-versions | awk '{print $2}')" >> $GITHUB_OUTPUT
          done
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ steps.tool-versions.outputs.bun }}
      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ runner.os }}-node-modules-${{ hashFiles('**/bun.lock') }}
      - name: Bun Install
        run: bun install --frozen-lockfile
      # Asset compilation is broken until this is fixed:
      # https://github.com/oven-sh/bun/issues/11895
      - name: Build Server
        working-directory: server
        run: bun build --compile --target bun-${{ matrix.target }}  --minify --sourcemap --bytecode ./src/index.tsx --outfile devicemonster-server-${{ matrix.target }}
      - name: Upload Release Artifact
        working-directory: server
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh release upload ${{ github.ref_name }} devicemonster-server-${{ matrix.target }}*

  release-server-docker:
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/server-')
    environment: Release
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - id: tool-versions
        name: Get Tool Versions
        run: |
          for tool in $(cat .tool-versions | awk '{print $1}'); do
            echo "$tool=$(grep "$tool" .tool-versions | awk '{print $2}')" >> $GITHUB_OUTPUT
          done
      - name: Set up QEMU for ARM64
        uses: docker/setup-qemu-action@v3
        with:
          platforms: 'arm64'
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: tiltcampbot
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Generate tags
        id: docker_tags
        uses: docker/metadata-action@v5
        with:
          context: git
          images: |
            tiltcamp/devicemonster
            ghcr.io/tiltcamp/devicemonster
          tags: |
            type=schedule
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=sha
      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          file: server/Dockerfile
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            BUN_VERSION=${{ steps.tool-versions.outputs.bun }}
          push: true
          tags: ${{ steps.docker_tags.outputs.tags }}
          labels: ${{ steps.docker_tags.outputs.labels }}
          platforms: |
            linux/amd64
            linux/arm64
